import React, { useState, useEffect } from 'react';
import { 
  FileText, Upload, Eye, CheckCircle, Briefcase, ArrowLeft, Search, File, 
  DollarSign, Hash, Loader2, LogIn 
} from 'lucide-react';

// --- FIREBASE IMPORTS ---
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInWithCustomToken,
  signInAnonymously,
  onAuthStateChanged,
  signOut
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  addDoc, 
  onSnapshot, 
  query, 
  deleteDoc,
  doc,
  orderBy
} from 'firebase/firestore';

// --- CONFIGURATION & SETUP ---

/**
 * NOTE FOR DEPLOYMENT:
 * To deploy this to CodeSandbox or Vercel:
 * 1. Replace the 'firebaseConfig' initialization below with your own keys:
 * const firebaseConfig = { apiKey: "...", ... };
 * 2. Update the Firestore collection paths to use standard root collections 
 * (e.g., collection(db, 'office_docs')) instead of the 'artifacts' path used here for the preview.
 */

// 1. Use Environment Config for Preview
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// --- COMPONENTS ---

const Card = ({ children, className = "" }) => (
  <div className={`bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden ${className}`}>
    {children}
  </div>
);

const Button = ({ children, onClick, variant = 'primary', className = "", disabled = false, icon: Icon }) => {
  const baseStyle = "px-4 py-2 rounded-lg font-medium transition-all flex items-center justify-center gap-2 active:scale-95";
  const variants = {
    primary: "bg-blue-700 text-white hover:bg-blue-800 disabled:bg-blue-400",
    secondary: "bg-white text-slate-700 border border-slate-300 hover:bg-slate-50",
    danger: "bg-red-50 text-red-600 hover:bg-red-100 border border-red-200",
    ghost: "text-slate-500 hover:bg-slate-100"
  };

  return (
    <button 
      onClick={onClick} 
      disabled={disabled}
      className={`${baseStyle} ${variants[variant]} ${className}`}
    >
      {Icon && <Icon size={18} />}
      {children}
    </button>
  );
};

const InputField = ({ label, name, type = "text", value, onChange, placeholder, required = false }) => (
  <div className="mb-4">
    <label className="block text-sm font-semibold text-slate-700 mb-1">
      {label} {required && <span className="text-red-500">*</span>}
    </label>
    <input
      type={type}
      name={name}
      value={value}
      onChange={onChange}
      placeholder={placeholder}
      required={required}
      className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
    />
  </div>
);

const Badge = ({ type }) => {
  const styles = {
    inquiry: "bg-purple-100 text-purple-700 border-purple-200",
    qtn: "bg-amber-100 text-amber-700 border-amber-200",
    order: "bg-emerald-100 text-emerald-700 border-emerald-200",
    completion: "bg-blue-100 text-blue-700 border-blue-200",
  };
  const labels = {
    inquiry: "Inquiry",
    qtn: "Quotation",
    order: "Confirmed Order",
    completion: "Certificate",
  };
  return (
    <span className={`px-2.5 py-0.5 rounded-full text-xs font-bold border ${styles[type] || "bg-slate-100 text-slate-600"}`}>
      {labels[type] || type}
    </span>
  );
};

// --- MAIN APP ---

export default function App() {
  const [user, setUser] = useState(null);
  const [view, setView] = useState('home'); 
  const [uploadType, setUploadType] = useState(null);
  const [documents, setDocuments] = useState([]);
  const [loading, setLoading] = useState(false);
  const [searchTerm, setSearchTerm] = useState('');
  const [notification, setNotification] = useState(null);

  const initialFormState = {
    clientName: '',
    date: new Date().toISOString().split('T')[0],
    referenceNo: '', 
    amount: '',
    description: '',
    contactPerson: '',
    fileName: '',
  };
  const [formData, setFormData] = useState(initialFormState);

  // --- AUTHENTICATION ---
  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  // --- DATA FETCHING ---
  useEffect(() => {
    if (!user) return;

    // NOTE: For internal preview, we MUST use the /artifacts/{appId}/public/data structure.
    // For external deployment, change this to: collection(db, 'office_docs')
    const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'office_docs'));
    
    const unsubscribeDocs = onSnapshot(q, 
      (snapshot) => {
        const docsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        // Manual sort since we can't use orderBy without an index in the preview environment
        docsData.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));
        setDocuments(docsData);
      },
      (error) => {
        console.error("Firestore Error:", error);
        showNotification("Sync error. Check permissions.", "error");
      }
    );
    return () => unsubscribeDocs();
  }, [user]);

  // --- ACTIONS ---

  const handleLogout = () => {
     // In this demo, we just reload or sign out, but since it auto-signs in, 
     // we'll just show a message.
     signOut(auth);
  };

  const showNotification = (msg, type = 'success') => {
    setNotification({ msg, type });
    setTimeout(() => setNotification(null), 3000);
  };

  const handleInputChange = (e) => {
    const { name, value } = e.target;
    setFormData(prev => ({ ...prev, [name]: value }));
  };

  const handleFileChange = (e) => {
    if (e.target.files[0]) {
      setFormData(prev => ({ ...prev, fileName: e.target.files[0].name }));
    }
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!user) return;
    setLoading(true);

    try {
      // NOTE: Path must match the listener above
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'office_docs'), {
        ...formData,
        type: uploadType,
        createdBy: user.uid,
        createdAt: new Date().toISOString(),
        status: 'Active'
      });

      showNotification("Document uploaded successfully!");
      setFormData(initialFormState);
      setView('home');
    } catch (err) {
      console.error("Upload error:", err);
      showNotification("Failed to upload. Check console.", "error");
    } finally {
      setLoading(false);
    }
  };

  const handleDelete = async (docId) => {
    if (!window.confirm("Delete this record?")) return;
    try {
      await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'office_docs', docId));
      showNotification("Record deleted.");
    } catch (err) {
      console.error("Delete error:", err);
      showNotification("Could not delete.", "error");
    }
  };

  // --- VIEWS ---

  if (!user) {
    return (
      <div className="min-h-screen bg-slate-50 flex items-center justify-center p-4">
        <Card className="w-full max-w-md p-8 text-center">
          <Loader2 className="animate-spin mx-auto text-blue-600 mb-4" size={32} />
          <p className="text-slate-500">Connecting to Office Cloud...</p>
        </Card>
      </div>
    );
  }
  
  return (
    <div className="min-h-screen bg-slate-50 font-sans text-slate-900">
      {/* Header */}
      <header className="bg-blue-900 text-white p-4 shadow-lg">
        <div className="max-w-5xl mx-auto flex justify-between items-center">
          <div className="flex items-center gap-3">
            <div className="bg-white/10 p-2 rounded-lg">
              <Briefcase size={24} className="text-blue-100" />
            </div>
            <div>
              <h1 className="text-xl font-bold tracking-wide">ROYAL ELECTRONICS</h1>
              <p className="text-xs text-blue-200">Sales & Office Portal</p>
            </div>
          </div>
          <div className="text-xs bg-blue-800 px-2 py-1 rounded">
            ID: {user.uid.slice(0, 6)}
          </div>
        </div>
      </header>

      {/* Notifications */}
      {notification && (
        <div className={`fixed top-4 right-4 px-6 py-3 rounded-lg shadow-xl z-50 text-white animate-bounce ${
          notification.type === 'error' ? 'bg-red-500' : 'bg-emerald-500'
        }`}>
          {notification.msg}
        </div>
      )}

      {/* Dashboard View */}
      {view === 'home' && (
        <div className="grid md:grid-cols-2 gap-6 max-w-4xl mx-auto mt-8 px-4">
          <button 
            onClick={() => setView('upload-select')}
            className="group bg-white hover:bg-blue-50 border-2 border-blue-100 hover:border-blue-500 transition-all p-8 rounded-2xl flex flex-col items-center justify-center gap-4 shadow-sm hover:shadow-md min-h-[240px]"
          >
            <div className="bg-blue-100 p-6 rounded-full group-hover:bg-blue-600 transition-colors">
              <Upload size={48} className="text-blue-600 group-hover:text-white transition-colors" />
            </div>
            <div className="text-center">
              <h2 className="text-2xl font-bold text-slate-800 mb-2">Upload Document</h2>
              <p className="text-slate-500">Inquiries, Qtn, Orders, Certs</p>
            </div>
          </button>

          <button 
            onClick={() => setView('view-all')}
            className="group bg-white hover:bg-emerald-50 border-2 border-emerald-100 hover:border-emerald-500 transition-all p-8 rounded-2xl flex flex-col items-center justify-center gap-4 shadow-sm hover:shadow-md min-h-[240px]"
          >
            <div className="bg-emerald-100 p-6 rounded-full group-hover:bg-emerald-600 transition-colors">
              <Eye size={48} className="text-emerald-600 group-hover:text-white transition-colors" />
            </div>
            <div className="text-center">
              <h2 className="text-2xl font-bold text-slate-800 mb-2">View Documents</h2>
              <p className="text-slate-500">Search and manage records</p>
            </div>
          </button>
        </div>
      )}

      {/* Upload Selection View */}
      {view === 'upload-select' && (
        <div className="max-w-2xl mx-auto mt-8 px-4">
          <Button variant="ghost" onClick={() => setView('home')} className="mb-6 pl-0">
            <ArrowLeft size={18} /> Back
          </Button>
          <h2 className="text-2xl font-bold text-slate-800 mb-6">Select Document Type</h2>
          <div className="grid gap-4">
            {[
              { id: 'inquiry', label: 'Upload Inquiry', icon: Search, color: 'bg-purple-600' },
              { id: 'qtn', label: 'Upload Quotation (QTN)', icon: FileText, color: 'bg-amber-600' },
              { id: 'order', label: 'Upload Order', icon: DollarSign, color: 'bg-emerald-600' },
              { id: 'completion', label: 'Completion Certificate', icon: CheckCircle, color: 'bg-blue-600' },
            ].map(opt => (
              <button
                key={opt.id}
                onClick={() => {
                  setUploadType(opt.id);
                  setFormData(initialFormState);
                  setView('upload-form');
                }}
                className="flex items-center gap-4 bg-white p-4 rounded-xl shadow-sm border border-slate-200 hover:border-blue-400 hover:shadow-md transition-all text-left"
              >
                <div className={`${opt.color} p-3 rounded-lg text-white`}>
                  <opt.icon size={24} />
                </div>
                <div className="font-bold text-lg text-slate-800">{opt.label}</div>
              </button>
            ))}
          </div>
        </div>
      )}

      {/* Upload Form View */}
      {view === 'upload-form' && (
        <div className="max-w-2xl mx-auto mt-8 px-4 pb-20">
          <Button variant="ghost" onClick={() => setView('upload-select')} className="mb-4 pl-0">
            <ArrowLeft size={18} /> Back
          </Button>
          <Card className="p-6 md:p-8">
             <div className="flex items-center gap-3 mb-6 border-b border-slate-100 pb-4">
                <h2 className="text-2xl font-bold text-slate-800 capitalize">{uploadType === 'qtn' ? 'Quotation' : uploadType} Form</h2>
             </div>
             <form onSubmit={handleSubmit}>
                <div className="grid md:grid-cols-2 gap-4">
                  <InputField label="Client Name" name="clientName" value={formData.clientName} onChange={handleInputChange} required />
                  <InputField label="Ref No" name="referenceNo" value={formData.referenceNo} onChange={handleInputChange} required />
                  <InputField label="Date" type="date" name="date" value={formData.date} onChange={handleInputChange} required />
                  <InputField label="Amount (₹)" name="amount" value={formData.amount} onChange={handleInputChange} />
                  <InputField label="Contact Person" name="contactPerson" value={formData.contactPerson} onChange={handleInputChange} />
                </div>
                <div className="mt-4">
                   <label className="block text-sm font-bold mb-1 text-slate-700">Remarks / Description</label>
                   <textarea name="description" value={formData.description} onChange={handleInputChange} className="w-full border border-slate-300 p-2 rounded-lg mb-4 focus:ring-2 focus:ring-blue-500 focus:outline-none" rows="3" />
                </div>
                <div className="mb-6 border-2 border-dashed border-slate-300 p-6 text-center rounded-lg bg-slate-50 hover:bg-slate-100 transition-colors">
                   <input type="file" onChange={handleFileChange} className="hidden" id="file-upload" />
                   <label htmlFor="file-upload" className="cursor-pointer flex flex-col items-center justify-center gap-2">
                      <Upload className="text-slate-400" />
                      <span className="text-blue-600 font-medium">{formData.fileName || "Click to Upload File"}</span>
                   </label>
                </div>
                <Button className="w-full py-3 text-lg" disabled={loading} icon={loading ? Loader2 : CheckCircle}>
                    {loading ? "Saving..." : "Submit Document"}
                </Button>
             </form>
          </Card>
        </div>
      )}

      {/* View All Documents */}
      {view === 'view-all' && (
        <div className="max-w-6xl mx-auto mt-8 px-4 pb-20">
          <div className="flex flex-col md:flex-row justify-between items-center gap-4 mb-6">
            <Button variant="ghost" onClick={() => setView('home')} className="pl-0 w-full md:w-auto justify-start"><ArrowLeft size={18}/> Back</Button>
            <div className="relative w-full md:w-80">
                <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={18} />
                <input 
                  placeholder="Search client..." 
                  className="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                  value={searchTerm}
                  onChange={e => setSearchTerm(e.target.value)} 
                />
            </div>
          </div>
          <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
            {documents
              .filter(d => 
                  d.clientName?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                  d.referenceNo?.toLowerCase().includes(searchTerm.toLowerCase())
              )
              .map(doc => (
              <Card key={doc.id} className="p-5 flex flex-col">
                <div className="flex justify-between items-start mb-3">
                  <Badge type={doc.type} />
                  <span className="text-xs text-slate-400">{new Date(doc.date).toLocaleDateString()}</span>
                </div>
                <h3 className="font-bold text-lg text-slate-800 mb-1">{doc.clientName}</h3>
                <div className="flex items-center gap-2 text-slate-500 text-sm mb-3">
                    <Hash size={14} /> {doc.referenceNo}
                </div>
                
                <div className="bg-slate-50 p-3 rounded-lg text-sm space-y-1 mb-4">
                    {doc.amount && <div className="flex justify-between"><span className="text-slate-500">Value:</span> <span className="font-medium text-emerald-600">₹{doc.amount}</span></div>}
                    {doc.fileName && <div className="flex justify-between items-center pt-2 border-t border-slate-200 mt-2"><span className="text-slate-500 flex items-center gap-1"><File size={12}/> File:</span> <span className="text-blue-600 truncate max-w-[120px]">{doc.fileName}</span></div>}
                </div>

                <div className="mt-auto pt-3 border-t border-slate-100 flex justify-end">
                  <button onClick={() => handleDelete(doc.id)} className="text-red-500 hover:bg-red-50 px-3 py-1 rounded text-xs font-medium transition-colors">Delete Record</button>
                </div>
              </Card>
            ))}
            {documents.length === 0 && (
                <div className="col-span-full text-center py-12 text-slate-400">No documents found. Upload one to get started.</div>
            )}
          </div>
        </div>
      )}
    </div>
  );
}
